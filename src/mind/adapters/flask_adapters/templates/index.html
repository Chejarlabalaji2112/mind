<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HITOMI Interface (Flask)</title>
    <style>
        /* --- KEEPING YOUR EXACT CSS STYLES --- */
        :root {
            --primary-hue: 174; 
            --primary: hsl(var(--primary-hue), 70%, 41%);
            --primary-glow: hsl(var(--primary-hue), 70%, 41%, 0.6);
            --bg-light: #e0e2e6; --text-light: #333333; --surface-light: rgba(255, 255, 255, 0.6);
            --border-light: rgba(0, 0, 0, 0.1); --chat-user-light: #d1e7dd; 
            --bg-dark: #000000; --text-dark: #c0c4c8; --surface-dark: rgba(20, 20, 20, 0.85);
            --surface-2-dark: #121212; --border-dark: rgba(255, 255, 255, 0.1); --chat-user-dark: #1e2226; 
            --bg: var(--bg-light); --text: var(--text-light); --surface: var(--surface-light);
            --surface-2: #f0f2f5; --border: var(--border-light); --chat-user-bg: var(--chat-user-light);
            --transition-speed: 0.3s;
        }
        [data-theme="dark"] {
            --bg: var(--bg-dark); --text: var(--text-dark); --surface: var(--surface-dark);
            --surface-2: var(--surface-2-dark); --border: var(--border-dark); --chat-user-bg: var(--chat-user-dark);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); height: 100vh; width: 100vw; overflow: hidden; transition: background-color 0.3s, color 0.3s; }
        
        /* Header & Layout */
        header { position: fixed; top: 0; left: 0; width: 100%; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; z-index: 100; transition: opacity 0.3s; }
        body.eyes-mode header { opacity: 0; pointer-events: none; }
        body.eyes-mode { background-color: #000 !important; }
        .clock-widget { position: absolute; left: 50%; transform: translateX(-50%); border: 1px solid var(--primary); padding: 6px 16px; border-radius: 20px; background: var(--surface); backdrop-filter: blur(12px); }
        .btn-icon { background: var(--surface); border: 1px solid var(--primary); color: var(--text); cursor: pointer; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(12px); }
        .btn-icon svg { width: 20px; height: 20px; fill: currentColor; }
        .actions, .left-actions { display: flex; gap: 10px; align-items: center; }

        /* Views */
        #main-stage { height: 100%; width: 100%; position: relative; }
        .view-section { height: 100%; width: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; animation: fadeIn 0.4s ease-out; }
        .view-section.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        /* Home */
        .hitomi-container { position: relative; display: flex; flex-direction: column; align-items: center; }
        .hero-title { font-size: 5rem; font-weight: 200; letter-spacing: 12px; text-transform: uppercase; z-index: 2; }
        .hitomi-pulse { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; height: 400px; z-index: 1; border-radius: 50%; box-shadow: 0 0 35px var(--primary-glow); animation: pulse 4s infinite; }
        .circle-stroke { fill: none; stroke: var(--primary); stroke-width: 6; stroke-dasharray: 1230; stroke-dashoffset: 1230; animation: drawCircle 2.5s ease-out forwards; }
        @keyframes drawCircle { to { stroke-dashoffset: 0; } }
        @keyframes pulse { 50% { box-shadow: 0 0 45px var(--primary-glow); } }
        .subtitle { z-index: 2; font-size: 1.2rem; margin-top: 20px; opacity: 0.7; letter-spacing: 3px; }

        /* Chat */
        #view-chat { flex-direction: row; align-items: stretch; justify-content: flex-start; }
        .chat-sidebar { width: 260px; background: var(--surface-2); border-right: 1px solid var(--border); padding: 80px 15px 20px; display: flex; flex-direction: column; gap: 10px; z-index: 50; }
        .sidebar-btn { padding: 12px; border-radius: 8px; background: transparent; border: 1px solid var(--border); color: var(--text); cursor: pointer; text-align: left; width: 100%; }
        .sidebar-btn.active { border-color: var(--primary); color: var(--primary); }
        .chat-main { flex-grow: 1; display: flex; flex-direction: column; padding-top: 80px; position: relative; }
        .chat-scroll-area { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .chat-container { width: 100%; max-width: 800px; display: flex; flex-direction: column; gap: 20px; padding-bottom: 150px; }
        .message-row { display: flex; gap: 15px; width: 100%; }
        .message-row.user { justify-content: flex-end; }
        .avatar { width: 35px; height: 35px; border-radius: 50%; background: var(--surface); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; flex-shrink: 0; }
        .avatar.ai { background: var(--primary); color: #000; border: none; font-weight: bold; }
        .bubble { padding: 15px 20px; border-radius: 18px; max-width: 80%; line-height: 1.5; }
        .message-row.user .bubble { background: var(--chat-user-bg); border-top-right-radius: 4px; }
        
        .input-area { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; padding: 0 20px; }
        .input-oval { width: 100%; max-width: 750px; background: var(--surface-2); border: 1px solid var(--border); border-radius: 30px; padding: 8px 20px; display: flex; align-items: flex-end; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #chat-input { flex-grow: 1; background: transparent; border: none; color: var(--text); font-size: 1rem; padding: 10px 0; resize: none; max-height: 150px; outline: none; }
        .send-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: 10px; }

        .typing-indicator { display: flex; gap: 5px; padding: 10px 0; }
        .dot { width: 6px; height: 6px; background: var(--text); border-radius: 50%; opacity: 0.3; animation: bounce 1.4s infinite ease-in-out both; }
        .dot:nth-child(1) { animation-delay: -0.32s; } .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Eyes */
        #view-eyes { background: #000; }
        #eyes-canvas { display: block; width: 100%; height: 100%; }

        /* Dock */
        .dock-container { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: var(--surface); backdrop-filter: blur(12px); border: 1px solid var(--primary); border-radius: 24px; padding: 12px 20px; display: flex; gap: 15px; z-index: 200; transition: transform 0.4s; }
        .dock-container.minimized { transform: translateX(-50%) translateY(200%); }
        .dock-item { width: 50px; height: 50px; border-radius: 14px; background: transparent; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .dock-item:hover { background: var(--primary-glow); transform: translateY(-8px) scale(1.1); }
        .dock-item svg { width: 24px; height: 24px; fill: var(--text); }
        .dock-toggle { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); background: var(--surface); border: 1px solid var(--primary); color: var(--text); width: 40px; height: 24px; border-radius: 12px; cursor: pointer; z-index: 201; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <header>
        <div class="left-actions">
            <button class="btn-icon" id="theme-toggle"><svg viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/></svg></button>
        </div>
        <div class="clock-widget" id="clock">12:00</div>
        <div class="actions">
            <button class="btn-icon" onclick="app.router.navigate('eyes')">
                <svg viewBox="0 0 24 24" style="width: 28px; height: 28px;">
                <path d="M6,6 C3,6 1,8.5 1,12 s2,6 5,6 s5-2.5 5-6 S9,6 6,6z M6,14 c-1.1,0-2-0.9-2-2s0.9-2,2-2s2,0.9,2,2S7.1,14,6,14z"/>
                <path d="M18,6 c-3,0-5,2.5-5,6s2,6,5,6s5-2.5,5-6S21,6,18,6z M18,14 c-1.1,0-2-0.9-2-2s0.9-2,2-2s2,0.9,2,2S19.1,14,18,14z"/>
                </svg>
            </button>
            <button class="btn-icon"><svg viewBox="0 0 24 24"><path d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42c1.33 1.33 2.17 3.14 2.17 5.07 0 4.2-3.8 7.7-8.5 7.7S3 14.89 3 10.89c0-1.93.84-3.74 2.17-5.07L4.17 5.17C2.45 6.89 1.48 9.07 1.48 11.39 1.48 16.4 5.9 20.3 11 20.3s9.52-3.9 9.52-8.91c0-2.32-.97-4.5-2.7-6.22z"/></svg></button>
        </div>
    </header>

    <main id="main-stage">
        <section class="view-section active" id="view-home">
            <div class="hitomi-container">
                <div class="hitomi-pulse"><svg class="hitomi-circle" width="400" height="400"><circle cx="200" cy="200" r="196" class="circle-stroke" /></svg></div>
                <h1 class="hero-title">HITOMI</h1>
                <div class="subtitle">Pupil of the Eye</div>
            </div>
        </section>

        <section id="view-chat" class="view-section">
            <aside class="chat-sidebar">
                <button class="sidebar-btn active" onclick="app.chat.newSession()">New Chat</button>
                <div class="history-list"><button class="sidebar-btn">History Item 1</button></div>
            </aside>
            <div class="chat-main">
                <div class="chat-scroll-area" id="scroller">
                    <div class="chat-container" id="message-container">
                        <div class="message-row ai"><div class="avatar ai">H</div><div class="bubble"><p>Hello! I am Hitomi. (Try saying "angry" or "happy")</p></div></div>
                    </div>
                </div>
                <div class="input-area">
                    <div class="input-oval">
                        <textarea id="chat-input" rows="1" placeholder="Message Hitomi..." oninput="app.chat.resizeInput(this)" onkeydown="app.chat.handleEnter(event)"></textarea>
                        <button class="send-btn" onclick="app.chat.sendMessage()"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-eyes" class="view-section"><canvas id="eyes-canvas"></canvas></section>
    </main>

    <button class="dock-toggle" id="dock-toggle" onclick="app.ui.toggleDock()"><svg id="dock-toggle-icon" viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg></button>
    <nav class="dock-container" id="dock">
        <button class="dock-item" onclick="app.router.navigate('home')"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></button>
        <button class="dock-item" onclick="app.router.navigate('chat')"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg></button>
        <button class="dock-item" onclick="app.router.navigate('eyes')"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg></button>
    </nav>

    <script>
        // --- ROBO EYES LOGIC (Unchanged logic) ---
        class RoboEyes {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.running = false;
                this.mood = 'DEFAULT'; 
                this.eyeL = { w: 200, h: 200, x: 0, y: 0 }; this.eyeR = { w: 200, h: 200, x: 0, y: 0 };
                this.target = { eyeL: { w: 200, h: 200, x: 0, y: 0 }, eyeR: { w: 200, h: 200, x: 0, y: 0 }, space: 50, eyelids: { tired: 0, angry: 0, happy: 0 } };
                this.current = { eyeL: { w: 200, h: 1, x: 0, y: 0 }, eyeR: { w: 200, h: 1, x: 0, y: 0 }, eyelids: { tired: 0, angry: 0, happy: 0 } };
                this.blinkTimer = 0;
                window.addEventListener('resize', () => this.resize());
                this.resize();
            }
            resize() {
                this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight;
                const baseSize = Math.min(this.canvas.width, this.canvas.height) * 0.35;
                this.target.eyeL.w = this.target.eyeL.h = this.target.eyeR.w = this.target.eyeR.h = baseSize;
                this.centerEyes();
            }
            centerEyes() {
                const totalW = this.target.eyeL.w + this.target.space + this.target.eyeR.w;
                const startX = (this.canvas.width - totalW) / 2;
                const startY = (this.canvas.height - this.target.eyeL.h) / 2;
                this.target.eyeL.x = startX; this.target.eyeL.y = startY;
                this.target.eyeR.x = startX + this.target.eyeL.w + this.target.space; this.target.eyeR.y = startY;
            }
            start() { if(!this.running) { this.running = true; this.loop(); } this.target.eyeL.h = this.target.eyeL.w; this.target.eyeR.h = this.target.eyeR.w; }
            stop() { this.running = false; }
            setMood(mood) { this.mood = mood; }
            blink() { this.current.eyeL.h = 1; this.current.eyeR.h = 1; }
            loop() {
                if(!this.running) return;
                const ease = 0.2;
                ['eyeL', 'eyeR'].forEach(e => {
                    ['w', 'h', 'x', 'y'].forEach(p => this.current[e][p] += (this.target[e][p] - this.current[e][p]) * ease);
                });
                let tTired = (this.mood === 'TIRED') ? this.current.eyeL.h/2 : 0;
                let tAngry = (this.mood === 'ANGRY') ? this.current.eyeL.h/2 : 0;
                let tHappy = (this.mood === 'HAPPY') ? this.current.eyeL.h/2 : 0;
                this.current.eyelids.tired += (tTired - this.current.eyelids.tired) * ease;
                this.current.eyelids.angry += (tAngry - this.current.eyelids.angry) * ease;
                this.current.eyelids.happy += (tHappy - this.current.eyelids.happy) * ease;

                if(Date.now() > this.blinkTimer) { this.blink(); this.blinkTimer = Date.now() + 3000 + Math.random()*2000; }
                this.draw();
                requestAnimationFrame(() => this.loop());
            }
            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                const color = getComputedStyle(document.body).getPropertyValue('--primary').trim();
                this.ctx.fillStyle = color;
                this.drawRoundedRect(this.current.eyeL); this.drawRoundedRect(this.current.eyeR);
                this.ctx.fillStyle = '#000';
                if(this.current.eyelids.angry > 1) { this.drawAngry(this.current.eyeL, false); this.drawAngry(this.current.eyeR, true); }
                if(this.current.eyelids.happy > 1) { this.drawHappy(this.current.eyeL); this.drawHappy(this.current.eyeR); }
            }
            drawRoundedRect(e) { 
                let r = 20; this.ctx.beginPath(); 
                this.ctx.roundRect(e.x, e.y, e.w, e.h, r); 
                this.ctx.fill(); 
            }
            drawAngry(e, flip) {
                this.ctx.beginPath();
                this.ctx.moveTo(e.x, e.y - 10); this.ctx.lineTo(e.x + e.w, e.y - 10);
                this.ctx.lineTo(flip ? e.x + e.w : e.x, e.y + this.current.eyelids.angry);
                this.ctx.fill();
            }
            drawHappy(e) {
                this.ctx.fillRect(e.x, (e.y + e.h) - this.current.eyelids.happy, e.w, this.current.eyelids.happy);
            }
        }

        // --- APP CONTROLLER ---
        const app = {
            state: { theme: 'dark', currentView: 'home', isProcessing: false },
            roboEyes: null,
            theme: {
                toggle: () => {
                    app.state.theme = app.state.theme === 'light' ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-theme', app.state.theme);
                }
            },
            router: {
                navigate: (viewId) => {
                    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                    document.getElementById(`view-${viewId}`).classList.add('active');
                    
                    const isEyes = viewId === 'eyes';
                    document.body.classList.toggle('eyes-mode', isEyes);
                    if(isEyes) {
                        if(!app.roboEyes) app.roboEyes = new RoboEyes('eyes-canvas');
                        app.roboEyes.start();
                    } else {
                        if(app.roboEyes) app.roboEyes.stop();
                    }

                    const dock = document.getElementById('dock');
                    const icon = document.getElementById('dock-toggle-icon');
                    if (viewId === 'home') {
                        dock.classList.remove('minimized');
                        icon.innerHTML = '<path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>';
                    } else {
                        dock.classList.add('minimized');
                        icon.innerHTML = '<path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>';
                    }
                }
            },
            chat: {
                resizeInput: (el) => { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 150) + 'px'; },
                handleEnter: (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); app.chat.sendMessage(); } },
                newSession: () => { document.getElementById('message-container').innerHTML = `<div class="message-row ai"><div class="avatar ai">H</div><div class="bubble"><p>New session started.</p></div></div>`; },
                appendMessage: (role, text) => {
                    const container = document.getElementById('message-container');
                    const row = document.createElement('div');
                    row.className = `message-row ${role}`;
                    row.innerHTML = (role === 'ai' ? `<div class="avatar ai">H</div>` : '') + `<div class="bubble"><p>${text}</p></div>` + (role === 'user' ? `<div class="avatar">U</div>` : '');
                    container.appendChild(row);
                    document.getElementById('scroller').scrollTop = document.getElementById('scroller').scrollHeight;
                },
                showLoading: () => {
                    const row = document.createElement('div'); row.id = 'loading-indicator'; row.className = 'message-row ai';
                    row.innerHTML = `<div class="avatar ai">H</div><div class="bubble"><div class="typing-indicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>`;
                    document.getElementById('message-container').appendChild(row);
                    document.getElementById('scroller').scrollTop = document.getElementById('scroller').scrollHeight;
                },
                removeLoading: () => { const el = document.getElementById('loading-indicator'); if(el) el.remove(); },
                
                // --- MODIFIED SEND METHOD FOR FLASK ---
                sendMessage: () => {
                    const input = document.getElementById('chat-input');
                    const text = input.value.trim();
                    if(!text || app.state.isProcessing) return;
                    
                    app.chat.appendMessage('user', text);
                    input.value = '';
                    app.state.isProcessing = true;
                    app.chat.showLoading();

                    // FETCH CALL TO FLASK API
                    fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: text })
                    })
                    .then(res => res.json())
                    .then(data => {
                        app.chat.removeLoading();
                        app.state.isProcessing = false;
                        
                        // Execute Python Commands
                        if (data.action === 'ai_response') {
                             python_execute('ai_response', data.data);
                        } else if (data.action === 'command_sequence') {
                            data.commands.forEach(c => python_execute(c.cmd, c.data));
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        app.chat.removeLoading();
                        app.state.isProcessing = false;
                    });
                }
            },
            ui: {
                toggleDock: () => {
                    const dock = document.getElementById('dock');
                    dock.classList.toggle('minimized');
                }
            }
        };

        // --- EXECUTION BRIDGE (Called by fetch response) ---
        function python_execute(action, data) {
            if (action === 'navigate') { app.router.navigate(data.view); }
            if (action === 'ai_response') { app.chat.appendMessage('ai', data.text); }
            if (action === 'eyes_mood' && app.roboEyes) { app.roboEyes.setMood(data.mood); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const updateClock = () => {
                const now = new Date();
                document.getElementById('clock').textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            };
            updateClock(); setInterval(updateClock, 1000);
            document.getElementById('theme-toggle').addEventListener('click', app.theme.toggle);
            app.router.navigate('home'); 
        });
    </script>
</body>
</html>